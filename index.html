/* =========================================================
   Daily Trivia — Duolingo-style daily flow (Wordle lock)
   Single Share button, dynamic score denominator
   ========================================================= */

const CATS = ["animals", "gaming", "marvel", "lotr", "cars", "hp"];
const LABELS = {
  animals: "🐾 Animals",
  gaming: "🎮 Gaming",
  marvel: "🦸‍♂️ Marvel",
  lotr:   "💍 Lord of the Rings",
  cars:   "🚗 Cars",
  hp:     "🪄 Harry Potter",
};

// Deterministic daily seed salt (all players share the same set per UTC day)
const PUBLIC_SALT = "dt-v1";

// ---- Question bank ----
const BANK = [
  { category:"animals", q:"Which mammal has the most powerful bite?", a:"Hippopotamus", distractors:["Tiger","Grizzly bear","Polar bear"] },
  { category:"animals", q:"Which sea creature has the largest eyes?", a:"Giant squid", distractors:["Blue whale","Manta ray","Oarfish"] },

  { category:"gaming",  q:"OSRS: what skill is trained by chopping trees?", a:"Woodcutting", distractors:["Fletching","Construction","Firemaking"] },
  { category:"gaming",  q:"Destiny 2: the main social hub is…", a:"The Tower", distractors:["The Farm","The City","The Reef"] },

  { category:"marvel",  q:"Thor’s hammer is called…", a:"Mjolnir", distractors:["Gungnir","Stormbreaker","Hofund"] },
  { category:"marvel",  q:"Who is the Winter Soldier?", a:"Bucky Barnes", distractors:["Sam Wilson","Steve Rogers","James Rhodes"] },

  { category:"lotr",    q:"Who destroys the One Ring (movies)?", a:"Frodo and Gollum", distractors:["Samwise","Gandalf","Aragorn"] },
  { category:"lotr",    q:"Frodo’s glowing sword is…", a:"Sting", distractors:["Glamdring","Andúril","Narsil"] },

  { category:"cars",    q:"Which brand makes the Mustang?", a:"Ford", distractors:["Chevrolet","Dodge","Toyota"] },
  { category:"cars",    q:"What does ABS stand for?", a:"Anti-lock Braking System", distractors:["Active Brake System","Auto Balance System","Advanced Braking Safety"] },

  { category:"hp",      q:"What house is Luna Lovegood in?", a:"Ravenclaw", distractors:["Hufflepuff","Gryffindor","Slytherin"] },
  { category:"hp",      q:"What position does Harry play in Quidditch?", a:"Seeker", distractors:["Chaser","Beater","Keeper"] },
  { category:"hp",      q:"What is the spell to disarm an opponent?", a:"Expelliarmus", distractors:["Stupefy","Petrificus Totalus","Lumos"] },
];

// ---- DOM helpers ----
const $  = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));

// HUD
const pointsEl   = $("#points");
const livesEl    = $("#lives");
const streakEl   = $("#streak");

// Quiz UI
const progressBar = $("#progress-bar");
const qCatEl      = $("#question-category");
const qTextEl     = $("#question-text");
const optionsEl   = $("#answer-options");

// Modals / screens
const rewardModal   = $("#reward-modal");
const rewardImg     = $("#reward-image");
const rewardName    = $("#reward-name");
const closeReward   = $("#close-reward");

const gameoverModal = $("#gameover-modal");
const restartBtn    = $("#restart-game");

const collectionModal = $("#collection-modal");
const openCollection1 = $("#open-collection");
const openCollection2 = $("#open-collection-2");
const closeCollection = $("#close-collection");
const collectionGrid  = $("#collection-grid");

// Results screen
const resCorrect   = $("#result-correct");
const resXP        = $("#result-xp");
const resXPBreak   = $("#result-xp-breakdown");
const resStreak    = $("#result-streak");
const resHearts    = $("#result-hearts");
const resPerfect   = $("#result-perfect");
const resRewardRow = $("#result-reward");
const resRewardImg = $("#result-reward-img");
const backHomeBtn  = $("#back-home");
const shareResultsBtn = $("#share-results"); // single share button
const resultScoreLabel = $("#result-score-label"); // optional label if present

// Home lock bits
const startBtn    = $("#start-game");
const lockMsg     = $("#lock-msg");
const countdownEl = $("#countdown");

// ---- Persistence (profile) ----
const KEY = "dt_profile_v4";
function loadProfile(){
  try {
    return JSON.parse(localStorage.getItem(KEY)) || {
      points: 0,
      streak: 0,
      lastPlayDate: null,
      hearts: 3,
      inventory: [],
      lastResults: null
    };
  } catch {
    return { points:0, streak:0, lastPlayDate:null, hearts:3, inventory:[], lastResults:null };
  }
}
function saveProfile(p){ localStorage.setItem(KEY, JSON.stringify(p)); }

let profile = loadProfile();

// Reset hearts each local day for now (streak is tracked per finishRun)
const todayStr = new Date().toISOString().split("T")[0];
if (profile.lastPlayDate !== todayStr){
  profile.hearts = 3;
  profile.lastPlayDate = todayStr;
  saveProfile(profile);
}

// ---- Wordle-style daily lock state (UTC) ----
const LS_KEY = "dt_daily_state_v1";
function loadDailyState(){ try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch { return {}; } }
function saveDailyState(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
function todayUTCKey(){ const d = new Date(); return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,"0")}-${String(d.getUTCDate()).padStart(2,"0")}`; }
function msUntilTomorrowUTC(){ const d = new Date(); const t = Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()+1, 0,0,0,0); return t - d.getTime(); }

let daily = loadDailyState();

function enforceDailyLock(){
  const played = daily.lastPlayed === todayUTCKey();
  if (played){
    startBtn?.setAttribute("disabled","disabled");
    lockMsg?.classList.remove("hidden");
    tickCountdown();
  } else {
    startBtn?.removeAttribute("disabled");
    lockMsg?.classList.add("hidden");
  }
}

function tickCountdown(){
  function fmt(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const hh = String(Math.floor(s/3600)).padStart(2,"0");
    const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
    const ss = String(s%60).padStart(2,"0");
    return `${hh}:${mm}:${ss}`;
  }
  function step(){
    if (countdownEl) countdownEl.textContent = fmt(msUntilTomorrowUTC());
    if (msUntilTomorrowUTC() <= 0){
      daily.lastPlayed = undefined;
      saveDailyState(daily);
      enforceDailyLock();
      return;
    }
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// ---- Core state ----
let session = newSession();

function newSession(){
  return {
    index: 0,
    correctCount: 0,
    hearts: profile.hearts,
    questions: buildDailyQuestions(),
    finished: false,
    rewardedToday: false,
    xpToday: 0,
    usedFinishBonus: false,
    results: []
  };
}

function buildDailyQuestions(){
  const now = new Date();
  const dayKey = `${now.getUTCFullYear()}-${now.getUTCMonth()+1}-${now.getUTCDate()}`;
  return CATS.map(cat => {
    const pool = BANK.filter(q => q.category === cat);
    if (!pool.length) return null;
    const offset = hashStr(`${PUBLIC_SALT}|${dayKey}|${cat}`) % pool.length;
    return pool[offset];
  }).filter(Boolean);
}

function hashStr(s){ let h = 2166136261; for (let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h+=(h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24); } return Math.abs(h>>>0); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

// ---- UI helpers ----
function renderHUD(){
  pointsEl.textContent = `⭐ ${profile.points}`;
  livesEl.textContent  = `❤️ ${session.hearts}`;
  streakEl.textContent = `🔥 ${profile.streak}`;
}

function switchScreen(which){
  ["home-screen","quiz-screen","stats-screen"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.classList.add("hidden");
  });
  document.getElementById(`${which}-screen`)?.classList.remove("hidden");
}

function updateProgress(){
  const total = session.questions.length || 1;
  const pct = (session.index / total) * 100;
  progressBar.style.width = `${pct}%`;
}

// ---- Flow ----
function startRun(){
  session = newSession();
  renderHUD();
  switchScreen("quiz");
  showCurrentQuestion();
}

function showCurrentQuestion(){
  updateProgress();
  const q = session.questions[session.index];
  if (!q){ finishRun(false); return; }
  qCatEl.textContent = LABELS[q.category] || "Trivia";
  qTextEl.textContent = q.q;

  const choices = shuffle([q.a, ...q.distractors]);
  optionsEl.innerHTML = "";
  choices.forEach(choice=>{
    const b = document.createElement("button");
    b.textContent = choice;
    b.addEventListener("click", () => onAnswer(q, choice, b));
    optionsEl.appendChild(b);
  });
}

function onAnswer(q, choice, clicked){
  // lock choices
  $$("#answer-options button").forEach(b => b.disabled = true);

  const correct = (choice === q.a);
  session.results.push(correct);

  // visual feedback
  $$("#answer-options button").forEach(b => { if (b.textContent === q.a) b.classList.add("correct"); });
  if (!correct && clicked) clicked.classList.add("wrong");

  // scoring
  if (correct){
    const prevXP = profile.points;
    profile.points += 10;
    session.xpToday += 10;
    session.correctCount += 1;
    maybeGrantBonusLife(prevXP);
  } else {
    profile.streak = 0;
    session.hearts -= 1;
    if (session.hearts <= 0){ finishRun(false); return; }
  }

  saveAndHUD();

  // next
  setTimeout(() => {
    session.index += 1;
    if (session.index >= session.questions.length){
      const perfect = session.correctCount === session.questions.length;
      finishRun(perfect);
    } else {
      showCurrentQuestion();
    }
  }, 600);
}

function saveAndHUD(){ saveProfile(profile); renderHUD(); }

function finishRun(perfect){
  session.finished = true;

  if (!session.usedFinishBonus){
    profile.points += 5;
    session.xpToday += 5;
    session.usedFinishBonus = true;
  }

  if (perfect){
    profile.points += 20;
    session.xpToday += 20;
    profile.streak += 1;
    maybeAwardSticker();
  }

  profile.hearts = session.hearts;
  renderHUD();

  // lock for today + save snapshot for Stats
  daily.lastPlayed = todayUTCKey();
  daily.lastResults = {
    date: daily.lastPlayed,
    correctCount: session.correctCount,
    xpToday: session.xpToday,
    hearts: session.hearts,
    perfect,
    results: session.results.slice()
  };
  saveDailyState(daily);
  enforceDailyLock();

  renderResults(perfect);
}

function renderResults(perfect){
  progressBar.style.width = "100%";

  // dynamic denominator
  const total = session.questions.length;
  if (resultScoreLabel) resultScoreLabel.textContent = `Score: ${session.correctCount}/${total}`;

  resCorrect.textContent = session.correctCount;
  resXP.textContent      = session.xpToday;
  resStreak.textContent  = `${profile.streak} 🔥`;
  resHearts.textContent  = `${session.hearts} ❤️`;

  const base  = session.correctCount * 10;
  const finish = 5;
  const bonus = perfect ? 20 : 0;
  resXPBreak.textContent = `+${base} (answers) +${finish} (finish)${perfect ? ` +${bonus} (perfect)` : ""}`;

  resPerfect.textContent = perfect ? "Perfect! 🎯" : "";
  if (perfect){
    resRewardRow.classList.remove("hidden");
    resRewardImg.src = rewardImg.src || "";
  } else {
    resRewardRow.classList.add("hidden");
  }

  renderResultGrid();
  switchScreen("stats");
}

function renderResultGrid(){
  const wrap = document.getElementById("result-grid");
  if (!wrap) return;
  wrap.innerHTML = "";
  const total = session.questions.length;
  for (let i = 0; i < total; i++){
    const box = document.createElement("div");
    box.className = "box";
    if (session.results[i] === true)  box.classList.add("ok");
    if (session.results[i] === false) box.classList.add("bad");
    wrap.appendChild(box);
  }
}

function maybeAwardSticker(){
  if (session.rewardedToday) return;
  session.rewardedToday = true;
  const idx = Math.floor(Math.random() * 4) + 1;
  const src = `assets/stickers/sticker_${idx}.png`;
  if (!profile.inventory.includes(src)) profile.inventory.push(src);
  rewardImg.src = src;
  rewardName.textContent = "Perfect day! New sticker unlocked 🎉";
  saveProfile(profile);
  rewardModal.classList.remove("hidden");
}

function renderCollection(){
  collectionGrid.innerHTML = "";
  if (!profile.inventory.length){
    collectionGrid.innerHTML = `<p class="muted">No stickers yet. Get a perfect day to unlock one!</p>`;
    return;
  }
  profile.inventory.forEach(src=>{
    const tile = document.createElement("div");
    tile.className = "tile";
    const img = document.createElement("img");
    img.src = src; img.alt = "Sticker";
    tile.appendChild(img);
    collectionGrid.appendChild(tile);
  });
}

function maybeGrantBonusLife(prevXP){
  const prevHundreds = Math.floor(prevXP / 100);
  const nowHundreds  = Math.floor(profile.points / 100);
  if (nowHundreds > prevHundreds && session.hearts < 5){
    session.hearts += 1;
  }
}

function toast(msg, ms=900){
  const t = document.createElement("div");
  t.className = "toast";
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), ms);
}

// ---- Share (single button) ----
function handleShare(){
  const total = session.questions.length;
  const text = `Daily Trivia — ${session.correctCount}/${total} correct!\n🔥 Streak: ${profile.streak}\n⭐ Total XP: ${profile.points}`;
  const url  = location.origin + location.pathname;

  if (navigator.share){
    navigator.share({ title: "Daily Trivia", text, url }).catch(()=>{});
  } else {
    navigator.clipboard.writeText(`${text}\n${url}`)
      .then(()=>toast("Copied results to clipboard"))
      .catch(()=>toast("Copy failed"));
  }
}

// ---- Events ----
startBtn?.addEventListener("click", startRun);

closeReward?.addEventListener("click", () => rewardModal.classList.add("hidden"));
restartBtn?.addEventListener("click", () => { gameoverModal.classList.add("hidden"); switchScreen("home"); });

openCollection1?.addEventListener("click", () => { renderCollection(); collectionModal.classList.remove("hidden"); });
openCollection2?.addEventListener("click", () => { renderCollection(); collectionModal.classList.remove("hidden"); });
closeCollection?.addEventListener("click", () => collectionModal.classList.add("hidden"));

backHomeBtn?.addEventListener("click", () => switchScreen("home"));
shareResultsBtn?.addEventListener("click", handleShare);

document.getElementById("open-stats")?.addEventListener("click", () => {
  const snapshot = (session.finished && session.results.length)
    ? { results: session.results, correctCount: session.correctCount, xpToday: session.xpToday, hearts: session.hearts, perfect: session.correctCount === session.questions.length }
    : daily.lastResults || profile.lastResults;

  if (!snapshot){ toast("No results yet"); return; }

  session.results      = snapshot.results || [];
  session.correctCount = snapshot.correctCount || 0;
  session.xpToday      = snapshot.xpToday || 0;
  session.hearts       = snapshot.hearts ?? profile.hearts;

  renderResults(snapshot.perfect === true);
});

// ---- Init ----
renderHUD();
switchScreen("home");
enforceDailyLock();
